<div class="modal">
    <div class="modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ECL Builder</h3>
                <button type="button" (click)="close()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div *ngIf="eclObject" class="expression-section">
                    <h3>Focus Concept</h3>
                    <ng-container *ngIf="!eclObject?.conjunctionExpressionConstraints && !eclObject?.disjunctionExpressionConstraints && !eclObject?.subexpressionConstraint">
                        <div class="expression-group">
                            <div class="expression-row">
                                <select [(ngModel)]="eclObject.operator" (ngModelChange)="updateExpression()">
                                    <option [value]="'self'" selected>Self</option>
                                    <option [value]="'descendantof'">Descendants</option>
                                    <option [value]="'descendantorselfof'">Descendants or self of</option>
                                    <option [value]="'ancestorof'">Parents</option>
                                    <option [value]="'ancestororselfof'">Parents or self of</option>
                                </select>
                                <input type="text" placeholder="Search..." [(ngModel)]="eclObject.fullTerm" (ngModelChange)="getConceptId(eclObject)" [ngbTypeahead]="search" placement="bottom"/>
                            </div>
                            <button (click)="newFocusConceptRow()">ADD ROW</button>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="eclObject?.conjunctionExpressionConstraints">
                        <div class="expression-group">
                            <div *ngFor="let conj of eclObject.conjunctionExpressionConstraints; let first = first" class="expression-row">
                                <select *ngIf="!first" (change)="convertConjunctionToDisjunction()">
                                    <option value="AND" selected>AND</option>
                                    <option value="OR">OR</option>
                                </select>
                                <select [(ngModel)]="conj.operator" (ngModelChange)="updateExpression()">
                                    <option [value]="'self'" selected>Self</option>
                                    <option [value]="'descendantof'">Descendants</option>
                                    <option [value]="'descendantorselfof'">Descendants or self of</option>
                                    <option [value]="'ancestorof'">Parents</option>
                                    <option [value]="'ancestororselfof'">Parents or self of</option>
                                </select>
                                <input type="text" placeholder="Search..." [(ngModel)]="conj.fullTerm" (ngModelChange)="getConceptId(conj)" [ngbTypeahead]="search" placement="bottom"/>
                            </div>
                            <button (click)="newFocusConceptRow()">ADD ROW</button>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="eclObject?.disjunctionExpressionConstraints">
                        <div class="expression-group">
                            <div *ngFor="let disj of eclObject.disjunctionExpressionConstraints; let first = first" class="expression-row">
                                <select *ngIf="!first" (change)="convertDisjunctionToConjunction()">
                                    <option value="AND">AND</option>
                                    <option value="OR" selected>OR</option>
                                </select>
                                <select [(ngModel)]="disj.operator" (ngModelChange)="updateExpression()">
                                    <option [value]="'self'" selected>Self</option>
                                    <option [value]="'descendantof'">Descendants</option>
                                    <option [value]="'descendantorselfof'">Descendants or self of</option>
                                    <option [value]="'ancestorof'">Parents</option>
                                    <option [value]="'ancestororselfof'">Parents or self of</option>
                                </select>
                                <input type="text" placeholder="Search..." [(ngModel)]="disj.fullTerm" (ngModelChange)="getConceptId(disj)" [ngbTypeahead]="search" placement="bottom"/>
                            </div>
                            <button (click)="newFocusConceptRow()">ADD ROW</button>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="eclObject?.subexpressionConstraint">
                        <div class="expression-group">
                            <div class="expression-row">
                                <select [(ngModel)]="eclObject.subexpressionConstraint.operator" (ngModelChange)="updateExpression()">
                                    <option [value]="'self'" selected>Self</option>
                                    <option [value]="'descendantof'">Descendants</option>
                                    <option [value]="'descendantorselfof'">Descendants or self of</option>
                                    <option [value]="'ancestorof'">Parents</option>
                                    <option [value]="'ancestororselfof'">Parents or self of</option>
                                </select>
                                <input type="text" placeholder="Search..." [(ngModel)]="eclObject.subexpressionConstraint.fullTerm" (ngModelChange)="getConceptId(eclObject.subexpressionConstraint)" [ngbTypeahead]="search" placement="bottom"/>
                            </div>
                        </div>
                    </ng-container>
                </div>

                <div class="expression-section">
                    <h3>Refinements</h3>
                    <button *ngIf="eclObject?.fullTerm" (click)="newAttributeGroup()">ADD GROUP</button>
                    <ng-container *ngIf="eclObject?.eclRefinement">
                        <div class="expression-group">
                            <div class="expression-row">
                                <input type="text" placeholder="Search..." [(ngModel)]="eclObject.eclRefinement.subRefinement.eclAttributeSet.subAttributeSet.attribute.attributeName.fullTerm"
                                       (ngModelChange)="getConceptId(eclObject.eclRefinement.subRefinement.eclAttributeSet.subAttributeSet.attribute.attributeName)" [ngbTypeahead]="search" placement="bottom"/>
                                <select [(ngModel)]="eclObject.eclRefinement.subRefinement.eclAttributeSet.subAttributeSet.attribute.expressionComparisonOperator" (ngModelChange)="updateExpression()">
                                    <option [value]="'='">=</option>
                                    <option [value]="'!='">!=</option>
                                </select>
                                <select [(ngModel)]="eclObject.eclRefinement.subRefinement.eclAttributeSet.subAttributeSet.attribute.attributeName.operator" (ngModelChange)="updateExpression()">
                                    <option [value]="'self'" selected>Self</option>
                                    <option [value]="'descendantof'">Descendants</option>
                                    <option [value]="'descendantorselfof'">Descendants or self of</option>
                                    <option [value]="'ancestorof'">Parents</option>
                                    <option [value]="'ancestororselfof'">Parents or self of</option>
                                </select>
                                <input type="text" placeholder="Search..." [(ngModel)]="eclObject.eclRefinement.subRefinement.eclAttributeSet.subAttributeSet.attribute.value.fullTerm"
                                       (ngModelChange)="getConceptId(eclObject.eclRefinement.subRefinement.eclAttributeSet.subAttributeSet.attribute.value)" [ngbTypeahead]="search" placement="bottom"/>
                            </div>
                            <ng-container *ngIf="eclObject.eclRefinement.subRefinement.eclAttributeSet.conjunctionAttributeSet">
                                <div *ngFor="let conjunctionAttributeSet of eclObject.eclRefinement.subRefinement.eclAttributeSet.conjunctionAttributeSet" class="expression-row">
                                    <select (change)="convertConjunctionRefinementToDisjunctionRefinement()">
                                        <option value="AND" selected>AND</option>
                                        <option value="OR">OR</option>
                                    </select>
                                    <input type="text" placeholder="Search..." [(ngModel)]="conjunctionAttributeSet.attribute.attributeName.fullTerm"
                                           (ngModelChange)="getConceptId(conjunctionAttributeSet.attribute.attributeName)" [ngbTypeahead]="search" placement="bottom"/>
                                    <select [(ngModel)]="conjunctionAttributeSet.attribute.expressionComparisonOperator" (ngModelChange)="updateExpression()">
                                        <option [value]="'='">=</option>
                                        <option [value]="'!='">!=</option>
                                    </select>
                                    <select [(ngModel)]="conjunctionAttributeSet.attribute.attributeName.operator" (ngModelChange)="updateExpression()">
                                        <option [value]="'self'" selected>Self</option>
                                        <option [value]="'descendantof'">Descendants</option>
                                        <option [value]="'descendantorselfof'">Descendants or self of</option>
                                        <option [value]="'ancestorof'">Parents</option>
                                        <option [value]="'ancestororselfof'">Parents or self of</option>
                                    </select>
                                    <input type="text" placeholder="Search..." [(ngModel)]="conjunctionAttributeSet.attribute.value.fullTerm"
                                           (ngModelChange)="getConceptId(conjunctionAttributeSet.attribute.value)" [ngbTypeahead]="search" placement="bottom"/>
                                </div>
                            </ng-container>
                            <ng-container *ngIf="eclObject.eclRefinement.subRefinement.eclAttributeSet.disjunctionAttributeSet">
                                <div *ngFor="let disjunctionAttributeSet of eclObject.eclRefinement.subRefinement.eclAttributeSet.disjunctionAttributeSet" class="expression-row">
                                    <select (change)="convertDisjunctionRefinementToConjunctionRefinement()">
                                        <option value="AND">AND</option>
                                        <option value="OR" selected>OR</option>
                                    </select>
                                    <input type="text" placeholder="Search..." [(ngModel)]="disjunctionAttributeSet.attribute.attributeName.fullTerm"
                                           (ngModelChange)="getConceptId(disjunctionAttributeSet.attribute.attributeName)" [ngbTypeahead]="search" placement="bottom"/>
                                    <select [(ngModel)]="disjunctionAttributeSet.attribute.expressionComparisonOperator" (ngModelChange)="updateExpression()">
                                        <option [value]="'='">=</option>
                                        <option [value]="'!='">!=</option>
                                    </select>
                                    <select [(ngModel)]="disjunctionAttributeSet.attribute.attributeName.operator" (ngModelChange)="updateExpression()">
                                        <option [value]="'self'" selected>Self</option>
                                        <option [value]="'descendantof'">Descendants</option>
                                        <option [value]="'descendantorselfof'">Descendants or self of</option>
                                        <option [value]="'ancestorof'">Parents</option>
                                        <option [value]="'ancestororselfof'">Parents or self of</option>
                                    </select>
                                    <input type="text" placeholder="Search..." [(ngModel)]="disjunctionAttributeSet.attribute.value.fullTerm"
                                           (ngModelChange)="getConceptId(disjunctionAttributeSet.attribute.value)" [ngbTypeahead]="search" placement="bottom"/>
                                </div>
                            </ng-container>
<!--                            <button (click)="newAttributeGroupRow(null)">ADD ROW</button>-->
                        </div>
                    </ng-container>
                </div>
                <div class="output-section">
                    <h3>Output</h3>
<!--                    <p class="output">{{eclObject | json}}</p>-->
<!--                    <p class="output">{{eclString}}</p>-->
                    <p class="output">
                        <span class="mb-0" style="display:block; white-space:pre" *ngFor="let line of ECLexpressionBuilder(eclString)">{{line}}</span>
                    </p>

                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="cancel" (click)="close()">CANCEL</button>
                <button type="button" class="accept" (click)="accept()">OK</button>
            </div>
        </div>
    </div>
    <div class="app-modal-background" (click)="close()"></div>
</div>
